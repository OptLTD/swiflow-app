name: Sync Assets to Cloudflare R2

on:
  release:
    types: [published, edited]

jobs:
  sync-release-to-r2:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    # æ˜ç¡®è®¾ç½®ä»“åº“ä¸Šä¸‹æ–‡å˜é‡
    env:
      R2_BUCKET_NAME: "swiflow"
      R2_ENDPOINT_URL: "https://2d002fceba7555e1c72fd486005708ea.r2.cloudflarestorage.com"

    steps:
      # ----------- ç¬¬ä¸€æ­¥ï¼šéªŒè¯ä¸Šä¸‹æ–‡ -----------
      - name: Debug context
        run: |
          echo "Release ID: ${{ github.event.release.id }}"
          echo "Tag åç§°: ${{ github.event.release.tag_name }}"

      # ----------- ç¬¬äºŒæ­¥ï¼šä¸‹è½½èµ„æº -----------
      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.MY_GH_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p release-assets

          echo "ğŸ”„ ä» OptLTD/swiflow-app è·å– Release èµ„æº..."
          api_url="https://api.github.com/repos/OptLTD/swiflow-app/releases/${{ github.event.release.id }}"
          
          # å¸¦é”™è¯¯å¤„ç†çš„è¯·æ±‚
          release_info=$(curl -fLsS \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "$api_url") || {
            echo "âŒ æ— æ³•è·å– Release ä¿¡æ¯"
            curl -v "$api_url" > debug.log  # ä¿å­˜è°ƒè¯•ä¿¡æ¯
            exit 1
          }

          # å®‰å…¨è§£æèµ„æºURL
          asset_urls=$(echo "$release_info" | jq -r '.assets[]?.browser_download_url // empty')
          [ -z "$asset_urls" ] && echo "â„¹ï¸ æ— é™„ä»¶èµ„æº" && exit 0

          echo "ğŸ“¦ éœ€è¦ä¸‹è½½çš„èµ„æºï¼š"
          for url in $asset_urls; do
            filename="${url##*/}"  # æ›´å®‰å…¨çš„æ–‡ä»¶åæå–
            echo "â¬‡ï¸ ä¸‹è½½: $filename"
            curl -fL \
              -H "Authorization: token $GH_TOKEN" \
              -o "release-assets/${filename}" \
              "$url" || echo "âš ï¸ ä¸‹è½½å¤±è´¥: $url"
          done

          echo "âœ… ä¸‹è½½å®Œæˆï¼"
          ls -lh release-assets/

      # ----------- ç¬¬ä¸‰æ­¥ï¼šé…ç½®R2è¿æ¥ -----------
      - name: Setup R2 credentials
        run: |
          pip install --quiet awscli
          mkdir -p ~/.aws

          # å®‰å…¨å†™å…¥å‡­è¯ï¼ˆé¿å…å‘½ä»¤æ³¨å…¥ï¼‰
          cat <<EOF > ~/.aws/credentials
          [default]
          aws_access_key_id = $(printf '%s' "${{ secrets.R2_ACCESS_KEY_ID }}" | sed 's/[\/&]/\\&/g')
          aws_secret_access_key = $(printf '%s' "${{ secrets.R2_SECRET_ACCESS_KEY }}" | sed 's/[\/&]/\\&/g')
          EOF

          cat <<EOF > ~/.aws/config
          [default]
          region = auto
          s3 =
            endpoint_url = $R2_ENDPOINT_URL
          EOF

      # ----------- ç¬¬å››æ­¥ï¼šä¸Šä¼ åˆ°R2 -----------
      - name: Upload to R2
        run: |
          set -e
          echo "ğŸš€ ä¸Šä¼ åˆ°: s3://$R2_BUCKET_NAME/"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          [ ! -d "release-assets" ] && echo "âŒ release-assets ç›®å½•ä¸å­˜åœ¨" && exit 1
          [ -z "$(ls -A release-assets)" ] && echo "â„¹ï¸ æ— æ–‡ä»¶å¯ä¸Šä¼ " && exit 0

          # ä½¿ç”¨awscliå¹¶è¡Œä¸Šä¼ 
          find release-assets -type f -print0 | xargs -0 -P 4 -I file \
            aws s3 cp file "s3://$R2_BUCKET_NAME/$(basename file)" \
            --endpoint-url "$R2_ENDPOINT_URL" \
            --no-progress

          echo "âœ… ä¸Šä¼ å®Œæˆ"

      # ----------- ç¬¬äº”æ­¥ï¼šæ¸…ç† -----------
      - name: Cleanup
        if: always()
        run: rm -rf release-assets